---
title: "R Programming Presentation"
author: "Daniel Dean, Jessica Nunez, Erin Walls, Chayou Zhai"
date: "12/13/2019"
output: powerpoint_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Research Question
What is the most frequently mentioned country in Jeopardy? ...
## Introduction
- We chose to ask this question out of an appreciation for the sciences of geography and cartography

## Methods
- Read in Jeopardy question data compiled by Github user `jwolle1`; initially (at all?) used Season 1

- Used `read_csv` from the `readr` package, although we manully downloaded the full dataset, a zipped file.

- The raw data already conformed to tidy data conventions, so no special pre-processing was needed on this front.

## Next Steps . . .
- We needed a list of names associated with countries

- Our basis was the `CountrySynomnyms` dataframe from the `rworldmap` package, this included up to 8 synonymous names for every country recognized as of 2005 (as well as historical country names), along with 3-letter abbreviations following the ISO3 standard. 

- We used the `pivot_longer` function from `tidyr` to convert this dataframe to two columns: ISO3 names and names (NAs were removed).

- To expand this dataset, names from the "lengthend" country names dataframe were matched against a list of country adjectives and demonyms (e.g. "Russian", "Russians") scraped from the Wikipedia page using the `rvest` package.

- These additional names were also converted to a single column, and matched to ISO3 codes.
## Matching Names
- We then used the `str_detect` and `str_extract_all` functions from `stringr` in tandem to locate and extract matches in Jeopardy questions or answers. 
  
- We avoided some false positives (e.g. "Indiana" includes the string "India") by excluding any match that was follwed by a letter (our target list included both singualr and plural forms of country adjectives/demonyms). 
  
## Finally . . .

* Because `str_extract_all` generates a list, we used <an option> to add NA values to equialize the products' lengths, and `unnest` from <`?`> to convert these into separate rows.

* We added the source (question or answer) as a metadata column, and merged both derived datasets to get a total frequency.


## Mapping

- The resulting table, with the original jeopardy data, our fequency tallies, and the ISO3 codes, was matched to a world map <*~`LowRest~` or something*> bundled with `rworldmap`, which also included ISO3 codes. 

- From there, we were able to use the `leaflet` package to make an interactive world map with frequncy of references in jeopardy color-coded with the `scheme we end up using` in <`ggplot?`>

## Leaflet
- We used leaflet package to map out out the countries mentioned, how many times they were mentioned and the airdates when they were mentioned. 

```{r pressure}
library("ggplot2")
library("readr")
library(leaflet)
library(tidyverse)
source("country_dataframes.R")
#To get country_all_isoobject; can comment this pout if already loaded

test_geom <- countriesLow %>% st_as_sf

test_geom_full <- country_all_iso %>%
  group_by(iso3) %>%
  add_tally(name = "count") %>%
  ungroup() %>%
  mutate(iso3 = toupper(iso3),
         iso3 = as.factor(iso3)) %>%
  rename(ISO3 = iso3) %>%
  full_join(test_geom) %>%
  mutate(ISO3 = as.factor(ISO3)) %>%
  clean_names() %>%
  st_as_sf

library("viridisLite")
pal <- colorNumeric(
  palette =  "Greens",
  domain = test_geom_full$count)

popup_info<- paste0("<b>Country:</b> ",
                      test_geom_full$name, "<br/>",
                    "<b>Population:</b> ",
                      test_geom_full$pop_est, "<br/>",
                    "<b>Count:</b> ",
                      test_geom_full$count, "<br/>",
                    "<b>Air Date:</b> ",
                      test_geom_full$air_date)
                    
                    

leaflet(test_geom_full) %>%
  addTiles() %>%
  addPolygons(color = ~pal(count), popup = popup_info)

```

## Plotly
- We used the plotly package to display the distribution of countries mentioned in daily doubles and how many times each country was mentioned

```{r plotly}
library(readr)
library(tidyverse)
library(dplyr)
library(rworldmap)
library(rvest)
library(tidyr)
library(janitor)
library(ggplot2)
library(rgeos)
library(data.table)
library(lubridate)
library(ggthemes)
library(plotly)
library(viridis)
source("daily_double_and_frequency.R")

# map creation
wmap <- getMap(resolution = "low")
wmap <- spTransform(wmap, CRS("+proj=robin"))
# get centroids
centroids <- gCentroid(wmap, byid = TRUE, id = wmap@data$ISO3)
centroids <- data.frame(centroids)
setDT(centroids, keep.rownames = TRUE)[]
setnames(centroids, "rn", "country_iso3c")

countrySynonyms_full <- countrySynonyms_full %>% 
  mutate_all(toupper)

all_country_iso <- country_all_iso_allszn %>% 
  mutate(date = ymd(air_date)) %>% 
  mutate(year = year(date)) %>% 
  select(c(round, value, daily_double, answer, question, country, iso3,
           type, date, year)) %>% 
  group_by(iso3) %>% 
  summarize(season_count = n()) %>% 
  left_join(countrySynonyms_full, by = c('iso3' = 'ISO3')) %>%  
  filter(name == "NAME1") %>% 
  mutate(country = str_to_title(country))

all_country_iso$hover = with(all_country_iso, paste(country, '<br>',
                                                    "Total:", season_count))


# join new data set to map
wmap_df <- fortify(wmap, region = "ISO3")
wmap_df <- left_join(wmap_df, all_country_iso, by = c('id' = 'iso3'))
wmap_df <- left_join(wmap_df, centroids, by = c('id' = 'country_iso3c'))


# plotly
p <- ggplot(data = wmap_df) +
  geom_polygon(aes(x = long, y = lat, group = group, fill = season_count,
                   text = hover)) +
  labs(fill = "Number of mentions") +
  theme_map() +
  scale_fill_viridis_c()

plotly <- ggplotly(p, tooltip = "text") %>% 
  layout(title = list(text = paste0('Number of country mentions',
                                    '<br>',
                                    '<sup>',
                                    'Daily Doubles, seasons 1-35',
                                    '</sup>')))

plotly
```
## Results

## Conclusion

## Tutorial

## Lessons Learned






## R Markdown

This is an R Markdown presentation. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.

## Slide with Bullets

- Bullet 1
- Bullet 2
- Bullet 3

## Slide with R Output

```{r cars, echo = TRUE}
summary(cars)
```

## Slide with Plot

```{r pressure}
library("ggplot2")
library(leaflet)
library(tidyverse)
source("country_dataframes.R") #To get country_all_isoobject; can comment this pout if already loaded

test_geom <- countriesLow %>% st_as_sf

test_geom_full <- country_all_iso %>%
  group_by(iso3) %>%
  add_tally(name = "count") %>%
  ungroup() %>%
  mutate(iso3 = toupper(iso3),
         iso3 = as.factor(iso3)) %>%
  rename(ISO3 = iso3) %>%
  full_join(test_geom) %>%
  mutate(ISO3 = as.factor(ISO3)) %>%
  clean_names() %>%
  st_as_sf

library("viridisLite")
pal <- colorNumeric(
  palette =  "Greens",
  domain = test_geom_full$count)

popup_info<- paste0("<b>Country:</b> ",
                      test_geom_full$name, "<br/>",
                    "<b>Population:</b> ",
                      test_geom_full$pop_est, "<br/>",
                    "<b>Count:</b> ",
                      test_geom_full$count, "<br/>",
                    "<b>Air Date:</b> ",
                      test_geom_full$air_date)
                    
                    

leaflet(test_geom_full) %>%
  addTiles() %>%
  addPolygons(color = ~pal(count), popup = popup_info)

```

